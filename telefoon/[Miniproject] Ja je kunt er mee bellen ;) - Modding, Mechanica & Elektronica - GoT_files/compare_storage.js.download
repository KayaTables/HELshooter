function CompareStorageProfileHandler(){this.productEditionIds=[],this.productEditionCache={},this.init()}function CompareStorage(){this.formName="compareProductListing",this.storageHandler=new CompareStorageProfileHandler,this.form=null,this.positionElement=null,this.popup=null,this.overviewList=null,this.currentProductCount=0,this.maxProductCount=jsConfig.get(["compare","compareMax"]),this.initialized=!1}function updateScoreStars(e){var t,i=Selector("#scoreFilter .sliderLabel")[0];i&&(i.style.marginLeft=-14*e+6+"px",(t=10*e)<10&&(t="0"+t),i.className="sliderLabel scoreStars score"+t)}Object.extend(CompareStorageProfileHandler.prototype,{init:function(){this.productEditionIds=this.getMostRecentBasket()},getMostRecentBasket:function(){var e=jsConfig.get(["compare","initialCompareBasket"]),t=jsConfig.get(["compare","timestamp"],0),i=this.getBasketFromStorage();return i&&i.timestamp>=t?i.productEditionIds:Array.isArray(e)&&t?(this.setBasketInStorage(e,t),e):[]},getBasketFromStorage:function(){if(!Browser.supports("sessionStorage"))return null;var e=sessionStorage.getItem("compare");return e&&JSON.parse(e)},setBasketInStorage:function(e,t){if(Browser.supports("sessionStorage")){var i=JSON.stringify({productEditionIds:e,timestamp:t});sessionStorage.setItem("compare",i)}},clearCache:function(){this.productEditionIds=[],this.productEditionCache={}},getProductEditionCount:function(){return this.productEditionIds.length},hasProductEditionId:function(e){return 0<=this.findPosition(e)},findPosition:function(e){return this.productEditionIds.indexOf(Number(e))},addProductEdition:function(e,t){(e=Number(e))&&(this.hasProductEditionId(e)?this.productEditionCache[e]=t:(this.productEditionCache[e]=t,this.productEditionIds.push(e),this.accessStorage("add",e),trackEventWt("addOneToCompare")))},deleteProductEdition:function(e){if(e=Number(e)){var t=this.findPosition(e);0<=t&&(this.productEditionIds.splice(t,1),delete this.productEditionCache[e]),this.accessStorage("delete",e),trackEventWt("removeOneFromCompare")}},deleteAll:function(){var e=this.getProductEditionIds().join(",");this.clearCache(),this.accessStorage("delete",e),trackEventWt("emptyCompareBasket")},getProductEditionIds:function(){return this.productEditionIds},getProductEditionData:function(){for(var e,t=[],i=0;i<this.productEditionIds.length;i++)e=this.productEditionIds[i],t.push(this.productEditionCache[e]);return t},updateCache:function(e){for(var t,i=0;i<this.productEditionIds.length;i++)if(!((t=this.productEditionIds[i])in this.productEditionCache))return this.accessStorage("get",0,e),!1;for(t in this.productEditionCache)if(!this.hasProductEditionId(t))return this.accessStorage("get",0,e),!1;return e&&e(this.getProductEditionData()),!0},accessStorage:function(e,t,i){try{Ajax.sendRequest(location.protocol+"//"+location.host+"/ajax/pricewatch/compare/"+e+"/",{method:"POST",type:"json",async:!0,nocache:!0,appendSid:!0,strictSidCheck:!0,handler:this.handleResponse.bind(this,i)},t?"productEditionIds="+t:"")}catch(e){"noSessionException"==e&&(alert("Er werd geen geldige sessie gevonden, de pagina wordt herladen"),location.reload(!0))}},handleResponse:function(e,t){var i=checkJsonResponse(t);if(i&&"productEditionData"in i){this.clearCache();for(var o,s,n=0;o=i.productEditionData[n++];)(s=Number(o.id))&&(this.productEditionIds.push(s),this.productEditionCache[s]=o);this.setBasketInStorage(this.productEditionIds,i.timestamp)}e&&e(this.getProductEditionData())}}),Object.extend(CompareStorage.prototype,{init:function(){var t=this;this.getCompareHeaderButtons().forEach(function(e){e.onclick=t.compareHeaderButtonClick.bind(t,e)}),this.update(),this.initialized=!0},update:function(){this.updateCheckBoxes(),this.updateProductCount()},compareHeaderButtonClick:function(e){hasClass(e,"selected")?this.popup&&this.popup.close(!0):this.buildOverview(e,null)},updateCheckBoxes:function(){var e,t,i=this.getAllCheckBoxes(),o=0;if(i.length)for(;e=i[o++];)t=this.storageHandler.hasProductEditionId(e.value),this.initialized&&e.checked==t||(e.checked=t,hasClass(e.parentNode,"fancyButton")&&this.updateFancyButton(e))},getAllCheckBoxes:function(){var e,t=[],i=this.formName&&document.forms[this.formName],o=i!=this.form;return i&&(o&&(i.onsubmit=this.submit.bind(this,"main")),(e=i.elements["products[]"])&&(t=e.length?Array.slice(e):[e]),this.form=i),(e=this.getEntityHeaderCheckBox())&&t.push(e),!o&&this.initialized||t.forEach(this.bindCheckbox.bind(this)),t},bindCheckbox:function(e){var t=e.parentNode;hasClass(t,"fancyButton")?t.onclick=this.checkFancy.bind(this,e):e.onclick=this.check.bind(this,e)},checkFancy:function(e){e.checked=!e.checked,this.updateFancyButton(e),this.check(e)},updateFancyButton:function(e){var t=e.parentNode,i=t.getAttribute("data-buttoncolor")||"white";e.checked?(addClass(e.nextSibling,"checked"),removeClass(t,i),addClass(t,"green")):(removeClass(e.nextSibling,"checked"),removeClass(t,"green"),addClass(t,i))},check:function(e){var t=e.value;if(e.checked){var i=e.parentNode,o={},s=i.getAttribute("data-productdata");if(s)o=JSON.parse(s);else{for(o={id:t,url:"#",img:null,name:"Product: "+t};i&&"TR"!=i.nodeName&&("DIV"!=i.nodeName||hasClass(i,"itemname"));)i=i.parentNode;Selector("a.thumb",i).forEach(function(e){e.href.contains("pricewatch/"+t)&&(hasClass(e,"empty")||(o.img=Selector("img",e)[0].src),o.url=e.href,o.name=e.title.escapeHtml())})}this.storageHandler.addProductEdition(t,o)}else this.storageHandler.deleteProductEdition(t);this.updateCheckBoxes(),this.buildOverview(e,t)},remove:function(e,t){this.storageHandler.deleteProductEdition(e),this.updateCheckBoxes(),this.buildOverview(this.positionElement),stopPropagation(t)},deleteAll:function(e){this.storageHandler.deleteAll(),this.updateCheckBoxes(),this.buildOverview(this.positionElement),stopPropagation(e)},createPopup:function(){if(!this.popup){if(this.popup=PopupGenerator.get("selectedProductsPopup"),!this.popup)return;this.popup.options.compareStorage=this}preload("deleteIcon","g/if/icons/delete_product.png"),this.overviewList=document.createElement("ul");var e=HTMLBuilder().built({n:"div",c:[{n:"div",a:{className:"header"},c:{n:"h3",t:"Geen producten in vergelijking"}},{n:"p",a:{className:"maxMessage error"},t:"Je kan niet meer dan "+this.maxProductCount+" producten vergelijken"},{n:"div",a:{className:"noProducts"},c:[{n:"p",t:"Je hebt nog geen producten in je vergelijking."},{n:"a",a:{className:"fancyButton grey clickOut",href:jsConfig.get("TnetBaseURL")+"pricewatch/"},t:"Naar de Pricewatch"}]},{n:"div",a:{className:"productListPopup scrollArea"},c:this.overviewList},{n:"div",a:{className:"compare clearfix"},c:[{n:"input",a:{type:"button",className:"fancyButton",value:"Vergelijk",onclick:this.submit.bind(this,"popup")}},{n:"a",a:{className:"deleteAll",onclick:this.deleteAll.bind(this)},t:"Verwijder lijst"}]}]});this.popup.setContent(e)},clearList:function(){for(;this.overviewList.hasChildNodes();)this.overviewList.removeChild(this.overviewList.lastChild)},buildOverview:function(e,t){if(this.popup||this.createPopup(),this.updateProductCount(),!this.storageHandler.getProductEditionCount()&&!this.isPopupInHeader(e))return this.popup.close(!0),void(this.positionElement=null);e&&(this.positionElement=e,hasClass(e.parentNode,"fancyButton")&&(e=e.parentNode),this.popup.show(e)),this.storageHandler.updateCache(this.buildList.bind(this,t))||(this.clearList(),this.overviewList.appendChild(HTMLBuilder().built({n:"li",h:this.popup.getLoadingMessage("Producten worden geladen...")})))},buildList:function(e,t){this.clearList();for(var i,o,s=0;i=t[s++];)o=this.buildProductListItem(i),i.id==e&&(o.className="fadeIn"),this.overviewList.appendChild(o);Scrollable.create(Selector(".productListPopup",this.popup.element)[0],{fadeShowMore:1})},popupOnShow:function(e){addClass(e.element,"scrollableList"),this.isPopupInHeader()?(addClass(e.offsetElement,"selected"),addClass(e.element,"menuHeaderPopup"),addClass(e.element,"compareHeaderPopup")):(hasClass(e.element,"compareHeaderPopup")&&(this.getCompareHeaderButtons().forEach(function(e){removeClass(e,"selected")}),removeClass(e.element,"compareHeaderPopup")),removeClass(e.element,"menuHeaderPopup"))},isPopupInHeader:function(e){return e||(e=this.positionElement),e&&hasClass(e,"icon")},popupOnClose:function(e){this.isPopupInHeader()&&(removeClass(e.offsetElement,"selected"),removeClass(e.element,"compareHeaderPopup"),this.setCounterHighlight(!1))},getCompareHeaderButtons:function(){return Selector(".icon.compare")},getEntityHeaderCheckBox:function(){return Selector(".entityHeader .specs .fancyButton.compare input")[0]},buildProductListItem:function(e){return HTMLBuilder().built({n:"li",a:{className:"listItem"},c:[{n:"img",a:{src:getPreloadImage("deleteIcon"),title:"product verwijderen uit selectielijst",className:"delProduct",onclick:this.remove.bind(this,e.id)}},{n:"a",a:{href:e.url,className:"thumb micro product"+(e.img?"":" empty")},c:e.img?{n:"img",a:{src:e.img,width:37,height:31}}:null},{n:"a",a:{href:e.url,className:"itemname"},h:e.name}]})},updateProductCount:function(){var e=this.storageHandler.getProductEditionCount(),t=this.initialized&&e>this.currentProductCount,i=1==e?" product":" producten";this.currentProductCount=e,this.popup&&(Selector("h3",this.popup.element)[0].innerHTML=e<1?"Geen producten in vergelijking":e+i+" in vergelijking",Selector("p",this.popup.element)[0].style.display=e>this.maxProductCount?"block":"none",Selector(".noProducts",this.popup.element)[0].style.display=e<1?"block":"none",Selector(".compare",this.popup.element)[0].style.display=e<1?"none":"block"),t?this.setCounterHighlight(!0):0==e&&this.setCounterHighlight(!1),NotificationNotifier.updateUnreadCounts({newCompareItemCount:e})},setCounterHighlight:function(t){var e=this.getCompareHeaderButtons(),i=Selector(".rightSidebarToggle")[0],o=0===this.currentProductCount;i&&e.push(i),e.forEach(function(e){toggleClass(e,"highlight",t),toggleClass(e,"empty",o)})},submit:function(e){if(0==this.storageHandler.getProductEditionCount())return alert("Je hebt geen producten aangevinkt om te vergelijken."),!1;var t=this.storageHandler.getProductEditionIds(),i=t.length;if(i>this.maxProductCount){if(!confirm("Je kan niet meer dan "+this.maxProductCount+" producten met elkaar vergelijken. Je hebt "+i+" producten geselecteerd. "+(i==this.maxProductCount+1?"Het laatste geselecteerde product in de lijst zal":"De laatste "+(i-this.maxProductCount)+" geselecteerde producten in de lijst zullen")+" worden genegeerd."))return!1;t=t.slice(0,this.maxProductCount),i=this.maxProductCount}"popup"==e&&this.isPopupInHeader()&&(e="header"),trackEventWt("productCompare",{3:e,4:""+i},!0);var o=this.form?this.form.action:jsConfig.get(["compare","defaultCompareUrl"]);return o=o.contains("/0/")?o.replace("/0/","/"+t.join(";")+"/"):o.replace(/\/+$/,"")+"/"+t.join(";")+"/",window.location.href=o,!1},positionPopup:function(e){if(this.isPopupInHeader())setRelativePosition(e.element,e.offsetElement,37,-336);else if(this.form&&hasClass(this.form,"reposition"))e.setAutoPosition();else{var t=getPageDimensions(),i=getOffsetTop(e.offsetElement)-t.offsetY,o=-20;e.arrow.className="arrow right",this.form&&(e.element.offsetHeight>this.form.offsetHeight-getOffsetTop(e.offsetElement,this.form)||e.element.offsetHeight>t.innerHeight-i&&e.element.offsetHeight<i)?(o=30-e.element.offsetHeight+Math.floor(e.offsetElement.offsetHeight/2),addClass(e.arrow,"lopsided")):(o=Math.floor(e.offsetElement.offsetHeight/2)-29,removeClass(e.arrow,"lopsided")),setRelativePosition(e.element,e.offsetElement,o,-330)}}}),window.PopupGenerator&&PopupGenerator.register("selectedProductsPopup",{arrow:["top","bottom"],className:"menuHeaderPopup scrollableList",offsetTop:8,offsetLeft:-13,forceReposition:!0,compareStorage:null,afterShow:function(e){this.compareStorage&&this.compareStorage.popupOnShow(e)},onClose:function(e){this.compareStorage&&this.compareStorage.popupOnClose(e)},setPosition:function(e){this.compareStorage&&this.compareStorage.positionPopup(e)}});var compareStorage=new CompareStorage;